<!DOCTYPE html>
<html lang="ru" ng-app="chat">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Попутчики: панель управления</title>
    <style type="text/css">
      body {
        padding-top: 40px;
      }

      .avatar {
        width: 60px;
        height: 60px;
      }

      .user.active {
        opacity: 1.0;
        box-shadow: 10px 11px 27px -15px rgba(0,0,0,0.43);
      }

      .user-add {
        text-aling: center;
        padding: 10px !important;
      }

      .count {
        float: right;
        margin-top: 20px;
      }

      .message {
        padding: 3px;
        border-radius: 3px;
        background-color: white;
        margin-bottom: 3px;
      }

      .your {
        background-color: #AEC6CF;
      }

      .user {
        background-color: white;
        border-radius: 3px;
        padding: 2px;
        opacity: 0.6;
        cursor: pointer;
        margin-bottom: 4px;
      }

      .username {
        margin-left: 2px;
      }

      #chat {
        height: 300px;
        overflow-y: scroll;
      }

      .circle {
        border-radius: 50%;
        color: green;
        position: absolute;
        top: 0;
        right: 0;
      }
    </style>
    <!-- Bootstrap -->
    <link href="/api/static/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
  <div class="container">
    <div class="jumbotron">
    <h1>Администрирование<h1>
    <h2>Сообщения</h2>
    <p><a href="/api/admin">Главная страница админки</a>
    <div class="row">
      <div class="col-md-3" ng-controller="AccountsController as accounts">
      Аккаунты под управлением
        <div class="user" 
          ng-repeat="account in accounts" 
          ng-class="{active: isActive(account)}" 
          ng-click="setActive(account)">
          <img ng-src="{{ account.avatar_url }}" alt="avatar" class="img-circle avatar">
          <span class="username">{{ account.name }}</span>
          <span class="badge count" ng-show="account.count">{{ account.count }}</span>
        </div>
        <div ng-controller="AccountSearch">
          <div class="user user-add" ng-click="activate()">добавить</div>
          <div ng-show="show">
            <form novalidate>
              <input type="text" name="text" placeholder="email" ng-model="email">
            </form>
            <div ng-repeat="account in result" ng-click="add(account)">{{ account.name }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
      Сообщения
      <div ng-controller="MessagesCountroller" id="chat" scroll-glue ng-model="glued">
        <div ng-repeat="message in messages" ng-class="{your: !isActive(message)}" class="message">{{ message.text }}</div>
      </div>
      <div>
        <form novalidate ng-submit="send()" ng-controller="MessageFormController">
          <input type="text" name="text" placeholder="сообщение" ng-model="text">
          <input type="submit" id="submit" value="отправить" />
        </form>
      </div>
      </div>
      <div class="col-md-3" ng-controller="ChatsController">
      Чаты
        <div class="user" 
          ng-repeat="account in chats" 
          ng-class="{active: isActive(account)}" 
          ng-click="setActive(account)">
          <img ng-src="{{ account.user.avatar_url }}" alt="avatar" class="img-circle avatar">
          <span class="username">{{ account.user.name }}</span>
          <span class="badge count" ng-show="account.count">{{ account.count }}</span>
          <div class="circle" ng-show="account.user.online">online</div>
        </div>
    </div>
  </div>

  <script src="/api/static/js/jquery.min.js"></script>
  <script src="/api/static/js/bootstrap.min.js"></script>
  <script src="/api/static/js/angular.js"></script>
  <script src="/api/static/js/angular-route.js"></script>
  <script src="/api/static/js/angular-local-storage.js"></script>
  <script src="/api/static/js/scrollglue.js"></script>
  <script type="text/javascript">

  var WS_RECONNECT = 1000;

  function ws() {
      try {
          var host = window.location.hostname;
          connection = new WebSocket('ws://' + host + '/api/realtime?id=5406ce2027d41003fa6a4d4b');
      } catch(e) {
          console.log("ws error", e)
          return setTimeout( ws, WS_RECONNECT );
      }
      connection.onopen = function () {
          console.log('ws connected')
      };

      connection.onmessage = function (event) {
          data = JSON.parse(event.data);
          console.log("got message", data);
      };

      connection.onclose = function () {
          console.log('ws closed; reconnecting')
          return setTimeout( ws, WS_RECONNECT );
      }

      return connection;
  }

  ws();

  var app = angular.module("chat", ['luegg.directives', 'LocalStorageModule']);
  var account_ids = [
    "5406ce2027d41003fa6a4d4b"
  ];

  app.controller('AccountsController', ['$scope', '$rootScope', '$http', 'localStorageService', function($scope, $rootScope, $http, localStorageService) {
    $scope.accounts = []; 
    $scope.account_ids = account_ids;
    localStorageService.bind($scope, 'account_ids', account_ids);
    $rootScope.active = null;
    $scope.update = function() {
      angular.forEach($scope.account_ids, function(value) {
        $scope.accounts = [];
        $http.get('/api/user/' + value).success(function(data) {
          $scope.accounts.push(data);
        });
      });
    };
    $scope.update();
    $scope.setActive = function(account) {
      $rootScope.active = account.id; 
    };
    $scope.isActive = function(account) {
      return account.id === $rootScope.active;
    };
    $scope.add = function(account) {
      $scope.accounts.push(account);
    };
  }]);
  app.controller('AccountSearch', ['$scope', '$rootScope', '$http', function($scope, $rootScope, $http) {
    $scope.email = "";
    $scope.result = [];
    $scope.show = false;
    $scope.activate = function(){
      $scope.show = !$scope.show;
    };
    $scope.$watch('email', function(){
      if (!$scope.email) {
        $scope.result = [];
        return;
      }
      $http.get('/api/users/' + $scope.email).success(function(data) {
        $scope.result = data;
      });
    });
  }]);
  app.controller('ChatsController', ['$scope', '$rootScope', '$http', function($scope, $rootScope, $http) {
    $scope.chats = [];
    $rootScope.chat = null;
    $scope.update = function() {
      if ($rootScope.active == null) {
        return
      }
      $http.get('/api/user/' + $rootScope.active + '/chats').success(function(data) {
        $scope.chats = data;
        if($scope.chats.length > 0) {
          $rootScope.chat = $scope.chats[0].id;
        }
      });
    };
    $rootScope.$watch('active', $scope.update);    
    $scope.setActive = function(chat) {
      $rootScope.chat = chat.id; 
    };
    $scope.isActive = function(chat) {
      return chat.id === $rootScope.chat;
    };
  }]);

  app.controller('MessageFormController', ['$scope', '$rootScope', '$http', function($scope, $rootScope, $http) {
    $scope.text = null;
    $scope.send = function() {
      if (!$scope.text) {
        return;
      }
      var message = {text: $scope.text, origin: $rootScope.active};
      $http({method: 'PUT', url: '/api/user/' + $rootScope.chat + '/messages', data: message}).success(function(data) {
        $scope.text = "";
        $rootScope.messages.push(message);
      });
    }
  }]);

  app.controller('MessagesCountroller', ['$scope', '$rootScope', '$http', function($scope, $rootScope, $http) {
    $rootScope.messages = [];
    $scope.glued = true;

    $scope.update = function() {
      if ($rootScope.active == null || $rootScope.chat == null) {
        return
      }
      $http.get('/api/chat/' + $rootScope.active + '/' + $rootScope.chat).success(function(data) {
        $rootScope.messages = data;
      });
    };
    $rootScope.$watch('chat', $scope.update);

    $scope.isActive = function(message) {
      return message.origin === $rootScope.active;
    };
  }]);
  </script>
  </body>
</html>